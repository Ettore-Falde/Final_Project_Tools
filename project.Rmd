---
title: "Final Project"
author: "Ettore Falde, Samoussa Fofana, Federico Basaglia"
date: "11/29/2021"
header-includes: 
   \usepackage{titling}
   \pretitle{\begin{center}\LARGE\includegraphics[width=12cm]{upc-positiu-p3005.png}\\[\bigskipamount]}
   \posttitle{\end{center}}
   \usepackage{graphicx}
   \usepackage{fancyhdr}
   \pagestyle{fancy}
   \setlength\headheight{28pt}
   \fancyhead[L]{\includegraphics[width=5cm]{upc-positiu-p3005.png}}
   \fancyfoot[LE,RO]{GPIM}
output: 
  pdf_document:
    latex_engine: xelatex
    number_sections: yes
  
   

---

\newpage
\tableofcontents
\newpage

# Introduction

In this report we consider that the new CEO of a specific IT company has contacted us because she wants us to **analyze the current Human Resources status** of the company. 
\ 
She has just sent a data set with all available employee information. As we can see, the **company has two locations**: the first one in **London**, and the second one in **Barcelona**.

The new CEO is concerned about several issues. She truly believes in gender equality in organizations as it implies a signal to society. On the other hand, she is concerned that the offices in Barcelona do not follow a similar structure to the one in London. **In her opinion, the structure of the Barcelona offices should tend towards the London structure.** In her meeting with us, she also told us that she would like to know the attitudes (e.g., satisfaction) of the employees across the different departments and if anything could be done to improve them. Finally, she commented that she is very concerned about the company's succession strategy and in particular some positions in certain departments.

Let's consider that the new CEO of a specific IT company has contacted us because she wants us to analyze the current Human Resources status of the company. She has just sent a data set with all available employee information. This information is in the attached data set. As we can see, the company has two locations: the first one in London, and the second one in Barcelona.

The new CEO is concerned about several issues. She truly believes in gender equality in organizations as it implies a signal to society. On the other hand, she is concerned that the offices in Barcelona do not follow a similar structure to the one in London. In her opinion, the structure of the Barcelona offices should tend towards the London structure. In her meeting with us, she also told us that she would like to know the attitudes (e.g., satisfaction) of the employees across the different departments and if anything could be done to improve them. Finally, she commented that she is very concerned about the company's succession strategy and in particular some positions in certain departments.

Based on this information, we need to carry out an exploratory data analysis and prepare a technical report (with Rmarkdown) and a technical presentation (5-10 minutes).

Note: It is highly recommended to seek external sources of information (either in dataset or report formats) for the analysis and the reporting.  


Based on this information, we will to carry out an exploratory data analysis and prepare a technical report (with Rmarkdown) and a technical presentation (5-10 minutes).

# Setup the software

The software used for the development of the study and the writing of the report is R[1]. The first step is to define the work directory and to load the libraries needed:  

```{r, echo = FALSE, message=FALSE, warning=FALSE}
# Directory
#setwd("/Users/ettorefalde/Documents/Ettore\ Falde/UNI/UPC/Tools\ for\ Decision\ Making\ /Final_Project_Tools")
```

```{r, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(GGally)
library(gridExtra)
library(yardstick)
library(broom)
library(janitor)
library(caTools)
library(ROCR)
library(corrplot)
library(tidytext)
library(glue)
library(scales)
library(plotly)
library(patchwork)
library(skimr)
library(RColorBrewer)
```

# Importing Data

The first step is to load the dataset in the system, and check the names of the variables. 
```{r}
source("functions_script.R")
```


```{r}
mydb <- read.csv2("dataset.csv")
# web_db <- read.csv("WA_Fn-UseC_-HR-Employee-Attrition.csv")
# names(web_db)
```

## Variables analysis 

We got the dataset from the website of Atenea, it is composed by 1506 observations of 36 variables.
The variables selected for this dataset  are:

1. **Age**: Variable that represent the age of the employee
2. **Attrition**: variable that represent the departure of employees from the organization for any reason
3. **BusinessTravel**: Represent how often an employee travel for work purpose 
4. **DailyRate**: The amount of money the employees are paid per day
5. **Department**: Department of the company at which the employee belong
6. **DistanceFromHome**: Employee home distance from the workplace 
7. **Education**: Educational level of the employee (1=Below College, 2=College,
3=Bachelor, 4=Master,5 = Doctor)
8. **EducationField**: Education field of employee (Human Resources, Life Sciencies, Marketing, Medical, Technical Degree, Other)
9. **EmployeeCount**: Coolumn all equal to 1 to count the total number of employee in the data set
10. **EmployeeNumber**: unique number to identify the employee
11. **EnvironmentSatisfaction**: level of environment satisfaction (1=Low, 2=Medium, 3=High, 4=Very High)
12. **Gender**: Gender of the employee (Male, Female) 
13. **HourlyRate**: The amount of money the employees are paid per hour
14. **JobInvolvement**: Level of involvement of the employee (1=Low, 2=Medium, 3=High, 4=Very High)
15. **JobLevel**: Is a category of authority in the company (1=low, 5=High)
16. **JobRole**: Represent the role cover by the employee (Sales Executive, Research Scientist, Laboratory Technician, Manufacturing Director, Healthcare Representative, Manager, Sales Representative, Research Director, Human Resources)
17. **JobSatisfaction**: Level of satisfaction of the employee (1=Low, 2=Medium, 3=High, 4=Very High)
18. **MaritalStatus**: Marital status of the employee ( Divorced, Married, Single)
19. **MonthlyIncome**: Monthly income of the employee 
20. **MonthlyRate**: Monthly rate of employee
21. **NumCompaniesWorked**: Number of companies for ehich the employee worked
22. **Over18**: If the age of the employee is higher than 18 (Y = yes, N = no)
23. **OverTime**: If the employee perform over time (Yes, No) 
24. **PercentSalaryHike**: Represent the percentage inrease of a salary
25. **PerformanceRating**: Performance rating of the employee (1=Low, 2=Good,3=Excellent,4=Outstanding)
26. **RelationshipSatisfaction**: Relationship satisfaction of the employee (1=Low, 2=Medium, 3=High, 4=Very High)
27. **StandardHours**: Standard working hour per **week?** (80 for everyone)
28. **StockOptionLevel**: Stock option level
29. **TotalWorkingYears**: Total years of working
30. **TrainingTimesLastYear**: Training hours of the last year
31. **WorkLifeBalance**: the amount of time you spend doing your job compared with the amount of time you spend with your family and doing things you enjoy (1=Bad,2=Good, 3=Better, 4=Best)
32. **YearsAtCompany**: Total years of working at the company
33. **YearsInCurrentRole**: Total years spent in the current position
34. **YearsSinceLastPromotion**: How many year ago the employee had the last promotion
35. **YearsWithCurrManager**: How many years the employee is with the actual manager
36. **City**: where the employee works (London, Barcelona)


# Cleaning Data

## Names
In this sub-point we are going to change the names of the variables in order to have all he names of the variables with the same layout. 
```{r}
mydb <- mydb %>% clean_names(., "snake")
```

## Dimensions
First of all, we are going to check the actual dimension of our dataset. 
Hence, from the following code we can  understand that there are 36 variables in total and 
```{r}
mydb %>% dim()
mydb %>% nrow()
mydb %>% ncol()
```

## Head and Tail
Here, we are going to check the first 10 elements at the beginning and at the end of the dataset. Consecutively, we are going to check the top and the bottom values of the main relevant variables to catch some errors. 
```{r, results='hide'}
mydb %>% head(10)
mydb %>% tail(10)
mydb<-rename(mydb, age =age)
mydb %>% arrange(desc(age)) %>% top_n(10, age) 
mydb %>% arrange(age) %>% top_n(-10, age) 
```

## Removing
In this part of the data cleaning we are going to remove all the blank rows, the duplicates and strange values that may affect our analysis.
```{r}
# Remove blank rows and columsn 
mydb <- mydb %>% remove_empty(c("rows", "cols"))

# Removing entries with too high and too low age
mydb <- mydb %>% filter(age <= 80 & age >= 16)
mydb <- mydb %>% filter(job_involvement <= 4)
mydb <- mydb %>% filter(num_companies_worked >= 0)
```
Therefore, as we can see, this line of code did not affected our dataset. So, this mean that there are no rows or columns that are empty.

Now, we are going to pass to the study of duplicates, by the _employee_number_ variable that we suggest it is the key.
```{r, results='hide'}
# Duplicates removal
mydb %>% get_dupes(employee_number)
mydb <- mydb %>% distinct(employee_number, .keep_all= TRUE)
```

## Checking n's  

Hence, now it is time to check the n's.
```{r, echo = FALSE, results='hide'}
mydb %>% tabyl(attrition)

mydb %>% tabyl(business_travel)
mydb <- mydb %>% filter(business_travel != "")

mydb %>% tabyl(department)
mydb <- mydb %>% filter(department != "")
mydb$department <- ifelse(mydb$department == 
                            "Research and Development", 
                          "Research & Development", mydb$department)
mydb$department <- ifelse(mydb$department == 
                            "HR", 
                          "Human Resources", mydb$department)

mydb %>% tabyl(education_field)
mydb <- mydb %>% filter(education_field != "")

mydb %>% tabyl(gender)
mydb <- mydb %>% filter(gender != "")
mydb$gender <- ifelse(mydb$gender == 
                            "female", 
                          "Female", mydb$gender)
mydb$gender <- ifelse(mydb$gender == 
                            "female ", 
                          "Female", mydb$gender)
mydb$gender <- ifelse(mydb$gender == 
                            "male", 
                          "Male", mydb$gender)


mydb %>% tabyl(job_role)
mydb <- mydb %>% filter(job_role != "")


mydb %>% tabyl(marital_status)
mydb <- mydb %>% filter(marital_status != "")
mydb$marital_status <- ifelse(mydb$marital_status == 
                            "Marrie", 
                          "Married", mydb$marital_status)
mydb$marital_status <- ifelse(mydb$marital_status == 
                            "Soltero", 
                          "Single", mydb$marital_status)


mydb %>% tabyl(over18)
mydb <- mydb %>% filter(over18 != "")
mydb %>% tabyl(city)
mydb$city <- ifelse(mydb$city == 
                            "Barcelone", 
                          "Barcelona", mydb$city)
```

## Droping na

To conclude, the cleaning of the dataset, we are going to remove every line with at least one empy gap. 
```{r}
mydb <- mydb %>% drop_na()
```


From know on we can easiliy proceed with our analysis. 











# Analysis
Our analysis consists in different parts. 

1. First of all, we want to describe the gender equality inside the company and understand if there are discrepancies and how we can solve those problems. 

2. Secondly, we want to understand the attrition factor and have a clear comprehension of what is the structure of the officies between Barcelona and London. This would be very helpful in otder to decrease the percentace of people who want to leave and how the company can improve the level of comfort of its employees.

3. Thirdly, we think is very important to describe the attitude of our employees and what it their satisfaction level. So, combining this solution with the previous question we can improve our decision and suggest to the company where it can adopt new HR methodologies. 

4. Fourthly, we want to understand how the company can find its successor and what could be the best solution. 

5. To conclude, there is also the good practice to import in our project new datasets that could improve the decions that we can take. 

## Introduction Analysis

### Plot job role frequency 
```{r, fig.align='left'}
# This would help to analyse the number of types of jobs and compare with types
k <- mydb %>% tabyl(job_role)

ggplot(k, aes(x = reorder(job_role, -n), y = n)) + 
  geom_bar(stat = "identity", fill = "#4271AE", colour = "#1F3552") + 
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) + 
  geom_text(aes(label = n), vjust = 0, colour = "#1F3552")+
  labs(y= "# of values", x = "job role") + 
  ggtitle("Job Role Frequency")

rm("k")
```

```{r}
ggplot(mydb, aes(x = job_role, color = city, fill = city)) + 
  geom_bar(stat = "count") + 
  theme(axis.text.x=element_text(angle=90,hjust=1,vjust=0.5)) + 
  ggtitle("Job Role Frequency Barcelona & London")
```


## Gender Analysis
First of all, we want to understand the salary that sex has. This would give us a better overview on how the salary is distributed inside the company. Moreover, we will also take into account the possibile differences that we have in the Barcelona and London headwarters. 


### Monthly Income 
It is pretty clear that the monthly income could be one of the most important variable that will determine the differences inside a compnay taking into accout the gender analysis. 

_Introduction_
```{r}
summary(mydb$monthly_income)
```

```{r}
mydb %>% select(monthly_income, gender) %>%
  ggplot(aes(monthly_income)) +
  geom_histogram(
    aes(monthly_income, color = gender, fill = gender),
    alpha = 0.4,
    position = "identity",
    bins = 50,
  ) +
  geom_freqpoly(aes(linetype = gender), bins = 30) +
  geom_rug(aes(color = gender)) +
  scale_x_continuous(labels = label_dollar()) +
  geom_vline(aes(xintercept = mean(monthly_income)), color = "#E67AEC", size = 1) +
  geom_vline(aes(xintercept = median(monthly_income)), color = "#6899F1", size = 1) +
  guides(color = "none") +
  labs(title = "Distridution of Monthly Income by Gender",
       caption = "BLUE = median; PINK = mean",
       x = "Monthly Income",
       y = NULL,
       fill = NULL,
       linetype = NULL) 
```

Hence, from this graph we can see that most of the employee have a salary lower than the average. In ddition, we can also see that generally we have the dotted male line almost always above the female line, but this can be considered acceptable, due to the fact that in our dataset we have more men and women.
To conclude, we can also see that the major discrepancies are given from the lower range of salary, while the higher is the salary, the lower are the differences between the female and male monthly income. 


Now, we will take a closer look to the monthly income between male an female . So, we can observe that the male have a worse results. While, the female has in medium an higher salray than man. 
```{r}
mydb %>% 
  select(gender, monthly_income) %>%
  group_by(gender) %>%
  summarise(avg_income = round(mean(monthly_income), 2), .groups = "drop") %>%
  ggplot(aes(x = gender, y = avg_income)) +
  geom_col(aes(fill = gender), width = 0.3, show.legend = FALSE) +
  geom_text(
    aes(
      x = gender,
      y = 0.01,
      label = dollar(avg_income, prefix = "EUR  ")
    ),
    hjust = -0.2,
    size = 4,
    colour = "white",
    fontface = "bold"
  ) +
  coord_flip() +
  scale_y_continuous(labels = label_dollar()) +
  theme(plot.title = element_text(size = 14, hjust = 0.5)) +
  labs(title = "Average Monthly Income by Gender",
       x = NULL,
       y = NULL)

```
Clearly, this difference is so minimal that we need to go further in detail to clearly understand if we can adopt any strategy to balance the gender inside a company or not. 


So, due to we also need to understan where is located this difference, we will filter by country. 
```{r}

# Barcelona
g1 <- mydb %>% filter(city == "Barcelona") %>% 
  select(gender, monthly_income) %>%
  group_by(gender) %>%
  summarise(avg_income = round(mean(monthly_income), 2), .groups = "drop") %>%
  ggplot(aes(x = gender, y = avg_income)) +
  geom_col(aes(fill = gender), width = 0.3, show.legend = FALSE) +
  geom_text(
    aes(
      x = gender,
      y = 0.01,
      label = dollar(avg_income, prefix = "EUR  ")
    ),
    hjust = -0.2,
    size = 4,
    colour = "white",
    fontface = "bold"
  ) +
  coord_flip() +
  scale_y_continuous(labels = label_dollar()) +
  theme(plot.title = element_text(size = 14, hjust = 0.5)) +
  labs(title = "Average Monthly Income by Gender: Barcelona",
       x = NULL,
       y = NULL)


# London
g2 <- mydb %>% filter(city == "London") %>% 
  select(gender, monthly_income) %>%
  group_by(gender) %>%
  summarise(avg_income = round(mean(monthly_income), 2), .groups = "drop") %>%
  ggplot(aes(x = gender, y = avg_income)) +
  geom_col(aes(fill = gender), width = 0.3, show.legend = FALSE) +
  geom_text(
    aes(
      x = gender,
      y = 0.01,
      label = dollar(avg_income, prefix = "EUR  ")
    ),
    hjust = -0.2,
    size = 4,
    colour = "white",
    fontface = "bold"
  ) +
  coord_flip() +
  scale_y_continuous(labels = label_dollar()) +
  theme(plot.title = element_text(size = 14, hjust = 0.5)) +
  labs(title = "Average Monthly Income by Gender: London",
       x = NULL,
       y = NULL)

grid.arrange(g1, g2, nrow = 2)

rm(g1, g2)
```

In this differentiation is definetely more clear how in Barcelona the monthly salary seems to privilege the female gender despite the male one. While, in London even if women has slightly higher average monthly salary, this is so small that can be omitted. In conclusion, we can focus to Barcelona and try to identify here the causes of this differences. 


### Department
```{r}
mydb %>%
  group_by(department, gender) %>% 
  summarise(amount = n(), .groups = "drop") %>%
  ggplot(aes(
    x = fct_reorder(department, amount),
    y = amount,
    fill = gender
  )) + 
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "top") + 
  labs(title = "Number of Employees by Department and Gender",
x = NULL,
y = NULL,
fill = NULL)
```
Therefore, in this graph we can see how inside the company we have the majority of employees in the field of research and development. Moreover, also here we can see that in general the male sex has an higher frequency in each department compared to to female one. 

Also here we found pretty important to stat that the differences between Barcelona and London to decide ultimately where to take decisions. 
```{r}
# Barcelona
g1 <- mydb %>% filter(city == "Barcelona") %>%
  group_by(department, gender) %>% 
  summarise(amount = n(), .groups = "drop") %>%
  ggplot(aes(
    x = fct_reorder(department, amount),
    y = amount,
    fill = gender
  )) + 
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "top") + 
  labs(title = "Barcelona",
x = NULL,
y = NULL,
fill = NULL)
  
# London
g2 <- mydb %>% filter(city == "London") %>%
  group_by(department, gender) %>% 
  summarise(amount = n(), .groups = "drop") %>%
  ggplot(aes(
    x = fct_reorder(department, amount),
    y = amount,
    fill = gender
  )) + 
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "top") + 
  labs(title = "London",
x = NULL,
y = NULL,
fill = NULL)
  
grid.arrange(g1, g2, nrow = 1)

rm(g1, g2)
```
Now, we can start seeing that the major differences about the number of employees and their distribution is mainly in London, while in Barcelona for instance, In the HR department we have almost the same number of employee per gender. 
This balance inside the company is a good sign of gender equality, even if there are some department, such as sales and R&D where the male sex is predominant In both London and Barcelona. 


### Job Role
The same analysis as above is represented below taking into account the _job_role_ variable.
```{r}
mydb %>%
  group_by(job_role, gender) %>% 
  summarise(amount = n(), .groups = "drop") %>%
  ggplot(aes(
    x = fct_reorder(job_role, amount),
    y = amount,
    fill = gender
  )) + 
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "top") + 
  labs(title = "Number of Employees by Job Role and Gender",
x = NULL,
y = NULL,
fill = NULL)
```

```{r}
# Barcelona
g1 <- mydb %>% filter(city == "Barcelona") %>%
  group_by(job_role, gender) %>% 
  summarise(amount = n(), .groups = "drop") %>%
  ggplot(aes(
    x = fct_reorder(job_role, amount),
    y = amount,
    fill = gender
  )) + 
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "top") + 
  labs(title = "Barcelona",
x = NULL,
y = NULL,
fill = NULL)

# London
g2 <- mydb %>% filter(city == "London") %>%
  group_by(job_role, gender) %>% 
  summarise(amount = n(), .groups = "drop") %>%
  ggplot(aes(
    x = fct_reorder(job_role, amount),
    y = amount,
    fill = gender
  )) + 
  geom_col(position = "dodge") +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "top") + 
  labs(title = "London",
x = NULL,
y = NULL,
fill = NULL)

grid.arrange(g1, g2, nrow = 1)

rm(g1, g2)
```
This two graphs seems to be relevant in some job roles. In fact, as we can see in Barcelona, women play an essential role in the two Director job roles. 

### Seniority

_Taking in consideration both company location_
In this graphs in order to show that up in a better way, we decided to remove the confidence interval and the points. 
```{r}
ggplot(mydb, aes(x=years_at_company, y=monthly_income, colour=gender))+ 
  geom_smooth(method = 'loess', formula = y ~ x, se=F) + 
  labs(title = "Income related to seniority to all company location",
       x = "Years in the company",
       y = "Monthly income") +
  theme_minimal()
```
So, as we can see here, generally speaking the female gender has an higher salary compare to the male gender. This is true  till approximately the 20th year of seniority inside the company where the male gender will overcome the female monthly income in a dramatic way. 


_Taking in consideration London_
```{r}
ggplot(mydb%>%filter(city=="London"), 
       aes(x=years_at_company, y=monthly_income, colour=gender)) + 
  geom_smooth(method = 'loess', formula = y ~ x, se=F) + labs(
      title = "Income related to seniority: London",
       x = "Years in the company",
       y = "Monthly income"
    ) +
  theme_minimal()
```
In the specific case of London we can stat that generally speaking the monthly income is well balanced between male and female work positions, but around the 15th year of seniority the male gender will have a boost in therm of monthly income. 


_Taking in consideration Barcelona_
```{r}
ggplot(mydb%>%filter(city=="Barcelona"), 
       aes(x=years_at_company, y=monthly_income, colour=gender)) + 
  geom_smooth(method = 'loess', formula = y ~ x, se=F) + labs(
      title = "Income related to seniority: Barcelona",
       x = "Years in the company",
       y = "Monthly income"
    ) + 
  theme_minimal()
```
Now, in Barcelona we can see hat the results we obtained is pretty different than before. In fact, the female gender has generally an higher income compared to the male gender. 

Other interesting graphs we can draw are the one related to the age. 
```{r}
mydb %>%
  select(age, monthly_income) %>%
  group_by(age) %>%
  summarise(avg_income = round(mean(monthly_income), 2), .groups = "drop") %>%
  ggplot(aes(x = age, y = avg_income)) +
  geom_col(aes(fill = age), width = 0.3, show.legend = FALSE) +
  coord_flip() +
  scale_y_continuous(labels = label_dollar()) +
  theme(plot.title = element_text(size = 14, hjust = 0.5)) +
  labs(title = "Average Monthly Income by Gender",
       x = NULL,
       y = NULL)

ggplot(mydb, 
       aes(x=age, y=monthly_income, colour=gender)) + 
  geom_smooth(method = 'loess', formula = y ~ x, se=F) + labs(
      title = "Income related to age",
       x = "Age",
       y = "Monthly income"
    ) + 
  theme_minimal()
```

### Education field
Performance rating education field. 
```{r}
ggplot(mydb, aes(y= education_field, x = monthly_income, fill = gender))+ 
  labs(y = "Eduction Field", x = "Monthly Income", title = "Income per gender and Education field") +
  geom_boxplot()

# Barcelona
g1 <- ggplot(mydb%>%filter(city == "Barcelona"), aes(y= education_field, x = monthly_income, fill = gender))+ 
  labs(y = "Eduction Field", x = "Monthly Income", title = "Barcelona") +
  geom_boxplot()

# London
g2 <- ggplot(mydb%>%filter(city == "London"), aes(y= education_field, x = monthly_income, fill = gender))+ 
  labs(y = "Eduction Field", x = "Monthly Income", title = "London") +
  geom_boxplot()

grid.arrange(g1, g2, nrow = 2)
rm(g1, g2)
```

So, in the first graph we can see that there are some differences. Hence we decided to locate them and understood that the major problems are in Barcelona. In fact, in the HR sector, women have an higher salary than men, also for technical degree we can see how the female gender seems to have a clear advantage on that. 

Clearly, per education field we can see also that in some cases also the male gender seems to have a slightly higer salary, but the main focus are those from which the discrepancy are very high, such as HR in Barcelona and Technical Degree, always in Barcelona. 


Moreover, we want also to understand if for the same job role the gender has a crucial role in the determination of the monthly income of each employee. 
```{r}
ggplot(mydb, aes(x = monthly_income, y = job_role, fill = gender)) + geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "top") + 
  labs(title = "Number of Employees by Job Role and Gender",
x = "monthly income",
y = "job role",
fill = NULL)


# Barcelona
ggplot(mydb%>%filter(city == "Barcelona"), aes(x = monthly_income, y = job_role, fill = gender)) + geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "top") + 
  labs(title = "Barcelona",
x = "monthly income",
y = "job role",
fill = NULL)

# London
ggplot(mydb%>%filter(city == "London"), aes(x = monthly_income, y = job_role, fill = gender)) + geom_boxplot() +
  theme(axis.text.x = element_text(angle = 90),
        plot.title = element_text(hjust = 0.5),
        legend.position = "top") + 
  labs(title = "London",
x = "monthly income",
y = "job role",
fill = NULL)
```
Hence, we can understand that also in this case the majority of the problem related to gender are located in Barcelona. 

### Regression
To conclude, we wanted also to see if the gender is a relevan variable that affect _monthly_income_ or other variables relavant for our study. 
```{r}
mod1 <- lm(monthly_income ~ ., data = mydb)
summary(mod1)

mod2 <- lm(monthly_income ~ gender, data = mydb)
summary(mod2)

names(mydb)
mod3 <- lm(monthly_income ~ age + gender + business_travel + education_field + education + distance_from_home + job_level + job_role + marital_status + total_working_years + performance_rating + years_at_company, data = mydb)
summary(mod3)

rm(mod1, mod2, mod3)
```

Hence, after this tree linear regression models we finally understood that actually the gender variable isn't significative to determine the monthly income. 
Anyway, this doesn't means that there are no discrepancy between gender, but simply that we need to develop an internal company analysis understand how in Barcelona for some kind of roles women and men have higher salaries compared to the opposite sex. 


## Attrition Analysis

First of all, we want to understand how the percentage of attrition is distributed inside the company. 
Then, we will differenciate per country. 
```{r}
# Create a temporary dataset to get the percentage of employees that would leave the company 
temp <- mydb %>% 
  group_by(attrition) %>%
  summarize(counts = n()) %>%
  mutate(percent = percentage_func(counts)) %>%
  arrange(desc(percent))

# Create a pie chart to see the percentage of people that will leave the company
pie_chart_func(dataset = temp, 
               counts_var = temp$counts, 
               var_interest = temp$attrition, 
               title = "Are the Attrition var Balanced?", 
               subtitle = "Pie Plot,percentortion of YES to NO in Attrition Var", 
               caption = "UPC")

# Removing the un-used variables
rm("temp")
```

```{r}
# Barcelona
# Create a temporary dataset to get the percentage of employees that would leave the company 
t1 <- mydb %>% filter(city == "Barcelona") %>%
  group_by(attrition) %>%
  summarize(counts = n()) %>%
  mutate(percent = percentage_func(counts)) %>%
  arrange(desc(percent))

g1 <- pie_chart_func(dataset = t1, 
               counts_var = t1$counts, 
               var_interest = t1$attrition, 
               title = "Barcelona", 
               subtitle = "Pie Plot,percentortion of YES to NO in Attrition Var",
               caption = "")

# London
t2 <- mydb %>% filter(city == "London") %>%
  group_by(attrition) %>%
  summarize(counts = n()) %>%
  mutate(percent = percentage_func(counts)) %>%
  arrange(desc(percent))

# Create a pie chart to see the percentage of people that will leave the company
g2 <- pie_chart_func(dataset = t2, 
               counts_var = t2$counts, 
               var_interest = t2$attrition, 
               title = "London", 
               subtitle = "Pie Plot,percentortion of YES to NO in Attrition Var",
               caption = "")


grid.arrange(g1, g2, nrow = 1)
# Removing the un-used variables
rm(g1, g2, t1, t2)
```
Fortunately, as we can see the percentage of attrition between Barcleona and London is almost the same, so we can proceed with a generalized analysis. 


```{r, message=FALSE, warning=FALSE}

mydb %>% select(starts_with("years"), attrition) %>% 

ggpairs(
  aes(color = attrition),
  lower = list(continuous = wrap(
    "smooth",
    alpha = 0.2,
    size = 0.5,
    color = "#DE945E"
  )),
  diag = list(continuous = "barDiag"),
  upper = list(continuous = wrap("cor", size = 4))
) +
  theme(
    axis.text = element_text(size = 8),
    panel.background = element_rect(fill = "white"),
    strip.background = element_rect(fill = "white"),
    strip.background.x = element_rect(colour = "black"),
    strip.background.y = element_rect(colour = "black"),
    strip.text = element_text(color = "black", face = "bold", size = 8)
  ) +
  labs(
    title = "Pair plot by attrition Var",
    subtitle = "Pair Plot, scatter plot, Histogram and Correlation coefficient",
    caption = "",
    x = NULL,
    y = NULL
  )
```



### Gender vs Attrition
```{r}
bar_plot_proportions(gender, attrition)
```
So, as we can see male tend to leave the comapny more the women does, but we also have to take into account the fact that there are more men in the company. Hence, the relation seems to be pretty balanced. 

### Marital status vs Attrition
```{r}
bar_plot_proportions(marital_status, attrition) 
```
Here, we can see how single people tend to leave the company more, compared to married and divorced. 

The _business_travel_ variable could be a very important variable that will tell us if the travels affect the attrition variable. 
```{r}
bar_plot_proportions(business_travel, attrition)
```
At the end, we have that the main obs that affect the attrition is the *_travel_rarely_*, which could that the non routine and the change of plans for the single employee could cause an higher attrition. Hence, we suggest to clarify with higher advance if that employee have to travel or not, and finally take the new results and compute a further analysis. 


The _department_ variable could be a very important variable that will tell us if the department affect the attrition variable. 
```{r}
bar_plot_proportions(department, attrition) 
```

Here instead, we can see how the R&D department seems the one with higher attrition. Anyway, we have also have to take into consideration that the majority of the people inside the company work in this department. 


Now, we want to study also the _job_role_ versus the _attrition_ variable. This would tell us what are the most common job positions that will affect this variable and where we can work in order to reduce the percentage of people who leave the company in the specific job role. 
```{r}
plt_job_role <- bar_plot_proportions(job_role)
plt_job_role_att <- bar_plot_proportions(job_role, attrition) 
(plt_job_role /
   plt_job_role_att) + 
  plot_annotation(
  title = "Proportions of Job role VS Attrition",
  caption = ""
) & 
  theme(plot.caption = element_text(color = "#969696", size = 7))
```
In this case, Laboratory Technician, Sales Executive, Research Scientist and Sales Representative, tend to leave the organisation more than others.

Another interesting graph that we can draw is the proportion of education version attrition.
```{r}
plt_education_field <- bar_plot_proportions(education_field)
plt_education_field_att <- bar_plot_proportions(education_field, attrition) 

(plt_education_field /
   plt_education_field_att) + 
  plot_annotation(
  title = "Proportions of Education field VS Attrition",
  caption = ""
) & 
  theme(plot.caption = element_text(color = "#969696", size = 7))
```

Hence, life sciences, meical will leave the company mroe frequently than the others. 


Another variable that can affect the attrition is the dummy variable if the employees work over time or not. 
```{r}
plt_education_field <- bar_plot_proportions(over_time)
plt_education_field_att <- bar_plot_proportions(over_time, attrition) 

(plt_education_field /
   plt_education_field_att) + 
  plot_annotation(
  title = "Proportions of over time work VS Attrition",
  caption = ""
) & 
  theme(plot.caption = element_text(color = "#969696", size = 7))
```
Therefore, we can conclude that if employees work more overtime they would tend to leave the company more than the people who do not. 
This variable is extremely significant becase as we can see the majority of the workers don't work overtime.



### Regression
In order to deal with _attrition_ we have to convert the yes or no variable into a binary variable. Once we did that we can work with the logistic regression model. 
Obviously, we are dealing now with a dummy variable. Hence, we can try to understand what are the variables that will affect our attrition. 
```{r}

mydb$attrition <-ifelse(mydb$attrition=="Yes",1,0)

mod1 <- glm(attrition ~ ., data = mydb)
summary(mod1)

mod2 <- glm(attrition ~ age + business_travel + distance_from_home + environment_satisfaction + job_involvement + job_role + job_satisfaction + num_companies_worked + over_time + relationship_satisfaction + training_times_last_year + work_life_balance + years_since_last_promotion, data = mydb)
summary(mod2)

rm(mod1, mod2)
```
To sum up, we can see that in the first regression we can see the diferent types of variables and their correlations, while in the second model we took only those variable with a low p-value in the _mod1_.

In conclusion the _mod2_ shows all the variables that have a significative effect in the the definition of the attrition variable. 




















_satisfaction of male and female in each department considering the whole data set_
```{r}
##Sales
g1 <- ggplot(mydb%>%filter(department =="Sales"), 
             aes(x= gender, y=job_satisfaction, fill= gender))+
  geom_boxplot(show.legend = FALSE)+
  labs(title = " Sales")

##Research & Development
g2 <- ggplot(mydb%>%filter(department =="Research & Development"), 
             aes(x= gender, y=job_satisfaction, fill= gender))+
  geom_boxplot(show.legend = FALSE)+
  labs(title = " Research & Development ")

##Human Resource
g3 <- ggplot(mydb%>%filter(department =="Human Resources"), 
             aes(x= gender, y=job_satisfaction, fill= gender))+
  geom_boxplot(show.legend = FALSE)+
  labs(title = " Human resource ")

grid.arrange(g1, g2, g3, ncol = 3)
```

## Differences between the two cities in term of job satisfaction 

### Sales, Gender, Job satisfaction

```{r}
##Sales  London
g4 <- ggplot(mydb%>%filter(department =="Sales" & city == "London"), 
             aes(x= gender, y= job_satisfaction, fill= gender))+
  geom_boxplot(show.legend = FALSE)+
  labs(title = " Sales London ")

##Sales  Barcelona
g5 <- ggplot(mydb%>%
               filter(department =="Sales" & city == "Barcelona"), 
             aes(x= gender, y=job_satisfaction, fill= gender))+
  geom_boxplot(show.legend = FALSE)+
  labs(title = " Sales Barcelona ")
grid.arrange(g4,g5, ncol = 2)
```

### R&D, Gender, Job satisfaction

```{r}
##Research & Development London 
g6 <- ggplot(mydb%>%
               filter(department =="Research & Development" & city=="London"), 
             aes(x= gender, y=job_satisfaction, fill= gender))+
  geom_boxplot(show.legend = FALSE)+
  labs(title = " R&D London")

##Research & Development Barcelona 
g7 <- ggplot(mydb%>%
               filter(department =="Research & Development" & city=="Barcelona"), 
             aes(x= gender, y=job_satisfaction, fill= gender))+
  geom_boxplot(show.legend = FALSE)+
  labs(title = " R&D Barcelona")

grid.arrange(g6,g7, ncol = 2)
```
 
### HR, Gender, Job satisfaction

```{r}
##Human Resource London

g8 <- ggplot(mydb%>%
               filter(department =="Human Resources" & city=="London"), 
             aes(x= gender, y=job_satisfaction, fill= gender))+
  geom_boxplot(show.legend = FALSE)+
  labs(title = " HR London")

##Human Resource BArcelona
g9 <- ggplot(mydb%>%
               filter(department =="Human Resources" & city=="Barcelona"), 
             aes(x= gender, y=job_satisfaction, fill= gender))+
  geom_boxplot(show.legend = FALSE)+
    labs(title = " HR Barcelona")

grid.arrange(g8,g9, ncol= 3)
```


```{r, fig.align='left'}
grid.arrange(g1, g2, g3, g4, g5, g6, g7, g8, g9, ncol = 3, top = "Comparison between job satisfaction and gender")

# clean variables
rm(g1, g2, g3, g4, g5, g6, g7, g8, g9)
```



















```{r}

```




```{r}
mean_mi <- round(mean(mydb$monthly_income),2)
median_mi <- round(median(mydb$monthly_income),2)
```


```{r}
ggplot(mydb,
       aes(x = gender,
           y = monthly_income,
           fill = gender)) +
  geom_boxplot(show.legend = FALSE) +
  coord_flip() +
   scale_y_continuous(labels = label_dollar()) +
  labs(title = "The gender gap in monthly income",
       caption = "Data Source: Kaggle IBM HR Employee Attrition",
       x = "Gender",
       y = "Monthly Income")
```

## Environment Satisfaction per department


###

```{r}
ggplot(mydb, aes(x= department, y= environment_satisfaction, fill = department))+
  geom_boxplot(show.legend = FALSE)
```

London male
```{r}
ggplot(mydb%>%filter(city == "London", gender== "Male"), aes(x= department, y= environment_satisfaction, fill = department))+
  geom_boxplot(show.legend = FALSE)
```
London female
```{r}
ggplot(mydb%>%filter(city == "London", gender== "Female"), aes(x= department, y= environment_satisfaction, fill = department))+
  geom_boxplot(show.legend = FALSE)
```
Barcelona malemale
```{r}
ggplot(mydb%>%filter(city == "Barcelona", gender== "Male"), aes(x= department, y= environment_satisfaction, fill = department))+
  geom_boxplot(show.legend = FALSE)
```

Barcelona Female
```{r}
ggplot(mydb%>%filter(city == "Barcelona", gender== "Female"), aes(x= department, y= environment_satisfaction, fill = department))+
  geom_boxplot()+ labs(show.legend = FALSE)
```
# linear regression to understand which variable influence monthly income 

```{r}
 #m1<-lm(city ~ ., mydb%>%drop_na()%>% select(-employee_count,-employee_number,-standard_hours))
#summary(m1)

```



- performance rating e percent salary hike,

```{r}
# Fa togliere 
# ggplot(mydb%>%filter(city == "Barcelona"), aes(y= percent_salary_hike, x = performance_rating))+
#   geom_point()
# 
# ggplot(mydb%>%filter(city == "London"), aes(y= percent_salary_hike, x = performance_rating))+
#   geom_point()
# 
# ggplot(mydb, aes(x= percent_salary_hike, y = monthly_income)) + geom_point()
```
We can


-

- total working year e age, years at company, relationship satisfaction, numb of companies worked, monthly income, job role, job level

- environment satisfaction e  over time (Yes), over 18, hourly rate, attrition yes

- job involvement job role, business travel and attrition

- job satisfaction attrition, years with current manager, overtime, marital status, hourly rate

-year since last promotion and, years in current role,years at company, job roles, attrition





# Adding dataset

```{r}
# UK
london_data<-read.csv("survey_results_public2.csv")
glimpse(london_data)

# Barcelona
barcelona_data <- read.csv("barcelona_dataset.csv")

# Clean Barcelona
barcelona_data <- rename(barcelona_data, age = db_bar.EDAT1899_1A7)
barcelona_data <- subset(barcelona_data, select = -X)
tabyl(barcelona_data$sex)
barcelona_data$sex <- ifelse(barcelona_data$sex == 
                            "DONA", 
                          "Female", barcelona_data$sex)
barcelona_data$sex <- ifelse(barcelona_data$sex == 
                            "HOME", 
                          "Male", barcelona_data$sex)

tabyl(barcelona_data$monthly_income)
barcelona_data$monthly_income <- ifelse(barcelona_data$monthly_income == 
                            "DE 1.001 A 1.500 EUROS", 
                          (1001+1500)/2, barcelona_data$monthly_income)
barcelona_data$monthly_income <- ifelse(barcelona_data$monthly_income == 
                            "DE 2.001 A 2.500 EUROS", 
                          (2001+2500)/2, barcelona_data$monthly_income)
barcelona_data$monthly_income <- ifelse(barcelona_data$monthly_income == 
                            "DE 2.501 A 3.000 EUROS", 
                          (2501+3000)/2, barcelona_data$monthly_income)
barcelona_data$monthly_income <- ifelse(barcelona_data$monthly_income == 
                            "DE 3.001 A 5.000 EUROS", 
                          (3001+5000)/2, barcelona_data$monthly_income)
barcelona_data$monthly_income <- ifelse(barcelona_data$monthly_income == 
                            "DE 5.001 A 7.000 EUROS", 
                          (5001+7000)/2, barcelona_data$monthly_income)
barcelona_data$monthly_income <- ifelse(barcelona_data$monthly_income == 
                            "DE 500 A 1.000", 
                          (500+1000)/2, barcelona_data$monthly_income)
barcelona_data$monthly_income <- ifelse(barcelona_data$monthly_income == 
                            "DE 7.001 A 9.000 EUROS", 
                          (7001+9000)/2, barcelona_data$monthly_income)
barcelona_data$monthly_income <- ifelse(barcelona_data$monthly_income == 
                            "MENYS DE 500 EUROS", 
                          (500)/2, barcelona_data$monthly_income)
barcelona_data$monthly_income <- ifelse(barcelona_data$monthly_income == 
                            "DE 1.501 A 2.000 EUROS", 
                          (1.501+2000)/2, barcelona_data$monthly_income)
barcelona_data$monthly_income <- ifelse(barcelona_data$monthly_income == 
                            "MÉS DE 9.000 EUROS", 
                          (10000), barcelona_data$monthly_income)
barcelona_data$monthly_income <- ifelse(barcelona_data$monthly_income == 
                            "DE 500 A 1.000 EUROS", 
                          (500+1000)/2, barcelona_data$monthly_income)

barcelona_data <- barcelona_data %>% filter(monthly_income != "NO CONTESTA")
barcelona_data <- barcelona_data %>% filter(monthly_income != "NO HO SAP")

barcelona_data$monthly_income <- as.numeric(barcelona_data$monthly_income)

```

## UK Comparation
```{r}
ggplot(london_data%>%filter(JobSatisfaction == "Extremely satisfied"), aes(x= CompanySize, fill = JobSatisfaction))+ geom_bar()+
  theme( axis.text.x  = element_text(angle=45, hjust=1, vjust=0.9))+ scale_x_discrete(limits = c("Fewer than 10 employees","10 to 19 employees","20 to 99 employees", "100 to 499 employees","500 to 999 employees", "1,000 to 4,999 employees", "5,000 to 9,999 employees", "10,000 or more employees"))
```


As we can see from this graph in the Uk if people work in a company which is small the satisfaction of the employee tends to increase with respect to a big vompany

### Carrer satisfaction

```{r, warning=FALSE}
ggplot(london_data, aes(x= CompanySize , fill = CareerSatisfaction))+ geom_bar()+
  theme( axis.text.x  = element_text(angle=45, hjust=1, vjust=0.9))+ scale_x_discrete(limits = c("Fewer than 10 employees","10 to 19 employees","20 to 99 employees", "100 to 499 employees","500 to 999 employees", "1,000 to 4,999 employees", "5,000 to 9,999 employees", "10,000 or more employees"))
```

## Barcelona Comparation

### Introduction Analysis
```{r}
summary(barcelona_data)
tabyl(barcelona_data$sex)

```
From this data we can see how the general mean of the monthly_income is €2686. 
Moreover, we can see how well this dataset is distributed between Male and Female. 

With the cleaned new dataset, we can make some analysis in order to have a general overview and can do a comparison between the starting datset solution and the new one.  
```{r}
barcelona_data %>% 
  select(sex, monthly_income) %>%
  group_by(sex) %>%
  summarise(avg_income = round(mean(monthly_income), 2), .groups = "drop") %>%
  ggplot(aes(x = sex, y = avg_income)) +
  geom_col(aes(fill = sex), width = 0.3, show.legend = FALSE) +
  geom_text(
    aes(
      x = sex,
      y = 0.01,
      label = dollar(avg_income, prefix = "EUR  ")
    ),
    hjust = -0.2,
    size = 4,
    colour = "white",
    fontface = "bold"
  ) +
  coord_flip() +
  scale_y_continuous(labels = label_dollar()) +
  theme(plot.title = element_text(size = 14, hjust = 0.5)) +
  labs(title = "Average Monthly Income by Gender",
       x = NULL,
       y = NULL)
```
In this case, we can see how in Barcelona Male has generally an higher salary compared to women.


```{r}
barcelona_data %>% ggplot(aes(x = age, y = monthly_income)) +
  geom_col(aes(fill = age), width = 0.3, show.legend = FALSE) +
  coord_flip() +
  scale_y_continuous(labels = label_dollar()) +
  theme(plot.title = element_text(size = 14, hjust = 0.5)) +
  labs(title = "Average Monthly Income by Gender",
       x = NULL,
       y = NULL)


barcelona_data %>% 
  select(age, monthly_income) %>%
  group_by(age) %>%
  summarise(avg_income = round(mean(monthly_income), 2), .groups = "drop") %>%
  ggplot(aes(x = age, y = avg_income)) +
  geom_col(aes(fill = age), width = 0.3, show.legend = FALSE) +
  geom_text(
    aes(
      x = age,
      y = 0.01,
      label = dollar(avg_income, prefix = "EUR  ")
    ),
    hjust = -0.2,
    size = 4,
    colour = "white",
    fontface = "bold"
  ) +
  coord_flip() +
  scale_y_continuous(labels = label_dollar()) +
  theme(plot.title = element_text(size = 14, hjust = 0.5)) +
  labs(title = "Average Monthly Income by Gender",
       x = NULL,
       y = NULL)
```
To conclude, we can understand here how the people between 65 and 74 years old have higher monthly_income.


# Conclusions
In the analysis we reach some conclusion let's take a look on what we reach.

We started by analyzing the frequency of the different role that we have in the dataset, we obtained that looking at the whole data set without differentiating by city the most frequent role are:

- Sales Executive
- Research Scientist
- Laboratory technician

The next step is relate to see if this path is followed also in the two city. The second graph show us that the distribution of the role is the same in both city.

Proceeding forward, we shift on the gender analysis to understand if both company reach the goal of the gender equality.

We fisrst calculate some statistcs indicator of the distribution of the monthly income, obtaining an average monthly income of 6510 euro.

We plotted a graph that show the genral situation of the whole company, and there we can see that on average the monthly income of the female employee tend to be higher. In fact, the average monthly income for male is 6395.65 while for the female is 6682.85 euro.

The next step will be to analyze the same point but after a distinction between the two different city. 

In both the city the monthly income of the female is higher than the male, but the gap in Barcelona is more significant.

Let's shift to the result that take in consideration also the department to which the employee belong.

In general the number of male per department is always higher with respect to the female, and the majority of personnel work in the Research & Development.

As before we will take a look also in the two different city. The gap between the gender per department is very high in London, but in Barcelona the HR department respect the gender eqaulity, so our CEO need to work firstly on the department of Sales and Research & Development.

Let's shift now on the job role, in all the role we have more male than female. From the graph where we don't differentiate between the city, all the role has more male than girl except the Manufacturing director role where the number of male and female are almost the same. We can state the same conclusion also if we analyze only London. In the case of Barcelona we have a slight difference, the female are higher in three role.

- Manager
- Research Director 
- Manufacturing director

Now, we want to write done the result obtained once we put in relation the monthly income versus the years in the company differentiating by gender and then by city also.

The whole picture dhow us that  in the initial stage the female tend to get more money with respect to the male, then in the middle stage from 8 years till 20 the income is almost the same, but in the final stage so after 20 years of seniority the gap between female and male increase in the favor of the male.

Looking to the two city, we can state the same things only the duration of the middle stage change, because now the male start earn more money 15 years of seniority. In barcelona the picture is totally different, female employee tend to earn more almost always.

Let's consider the monthly income in relation to the different department and differentiate also by gender. 

In the graph where we consider at the same time both the city we can see that the differences in income are present in the education field of technical degree and Human resource cause the mean of female income with respect to trhe male is more bigger. Considering the two city the problem are still present but in Barcelona is more bigger.

We carried out the same type of analysis but now focusing on the job role instead of education field. We obtained that in general the income as the same path for both male and female, but in two role which are Research Director and Manager the male tend to earn more than the female. In barcelona the discrepancy is present for both cause in some role male earn in average more than female and also the contrary happen. While in London only the research director show a big gap in favor of the male.

# Referemces
1. _M., L. (2004). Moneyball: The art of winning an unfair game. New york: John Wiley and sons._
2. Wickham et al., (2019). Welcome to the tidyverse. Journal of Open Source Software, 4(43), 1686, https://doi.org/10.21105/joss.01686
3. H. Wickham. ggplot2: Elegant Graphics for Data Analysis. Springer-Verlag New York, 2016.
4. David Robinson, Alex Hayes and Simon Couch (2021). broom: Convert Statistical Objects into Tidy Tibbles. R package version 0.7.9. https://CRAN.R-project.org/package=broom




